# TEGGTouch 编辑工具栏架构分析

## 变更摘要 (2026-02-19)

中心轮盘（Wheel Sectors）功能已完成从 **仅绘制** 到 **全功能交互** 的升级，覆盖编辑/运行/持久化三层：

### 1. 数据结构 (`core/constants.py`)
- `default_wheel_sectors()` 返回 8 个扇区，每个含完整按钮字段：
  `name, hover, lclick, rclick, mclick, wheelup, wheeldown, hover_delay, hover_release_delay`
- 新增常量 `WHEEL_INNER_RADIUS=60`, `WHEEL_OUTER_RADIUS=150`, `WHEEL_SECTOR_GAP_DEG=3`
- 按钮类型标记 `BTN_TYPE_WHEEL_SECTOR = 'wheel_sector'`

### 2. 持久化 (`core/config_manager.py`)
- `save_profile()` 新增 `wheel_visible` + `wheel_sectors` 参数
  - 保存时自动过滤运行时字段（`id_poly`, `id_text`, `_cx`, `_cy` 等）
- `load_profile()` 读取 `wheel_visible` + `wheel_sectors`，缺失时用默认值回退

### 3. 渲染 (`ui/canvas_renderer.py`)
- 轮盘扇区配色与普通按钮统一：`COLOR_BTN_BG` / `COLOR_BTN_BORDER` / `COLOR_TEXT`
- 移除了旧 `COLOR_WHEEL_*` 常量引用
- 扇区默认只显示名称（不再显示 hover 键值）
- 新增 **放射充能条** 函数：
  - `draw_wheel_charge_bar(canvas, sector, progress)` — 环形扇面充能动画
  - `remove_wheel_charge_bar(canvas, sector)` — 移除充能条并恢复外观
- 扇区操作配色与按钮共用 `ACTION_STATE_COLORS` 色板

### 4. 编辑 (`ui/app.py`)
- `__init__` 从 profile 加载 `wheel_visible` / `wheel_sectors`
- `_edit_wheel_sector()` 调用 `open_button_editor()` 复用按钮编辑弹窗
- `save_config()` 传递 `wheel_visible` / `wheel_sectors`
- `switch_profile()` 加载新方案时同步轮盘数据

### 5. 运行交互 (`ui/run_engine.py`)
- 轮盘扇区参与 **穿透判定**（`wheel_sector_hit_test` 加入 `is_on_ui` 检测）
- 完整交互支持：
  - **Hover**：悬停触发/释放（支持 `hover_delay` 充能条 + `hover_release_delay` 释放倒计时）
  - **Click**：左/右/中键 press & release
  - **Wheel**：滚轮上/下 + 0.15s 闪烁
- 每个扇区维护独立状态：`active_hover`, `_hover_enter_time`, `_hover_charged`, `_hover_release_time`, `_holding_left/right/middle`, `_wheel_flash_until`

---

## 文件修改清单

| 文件 | 变更 |
|------|------|
| `core/constants.py` | 已有完整数据结构，无需改动 |
| `core/config_manager.py` | `save_profile` / `load_profile` 增加轮盘持久化 |
| `ui/canvas_renderer.py` | 统一配色 + 放射充能条 + 清理 COLOR_WHEEL_* |
| `ui/app.py` | 从 profile 加载/保存轮盘 + 双击编辑调用 button_editor |
| `ui/run_engine.py` | 穿透判定 + 完整 hover/click/wheel 交互 |
